<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Werkbon v49</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 10px; color: #333; margin: 0; }
        .container { max-width: 650px; margin: auto; display: none; padding-bottom: 100px; }
        .login-container { max-width: 350px; margin: 80px auto; text-align: center; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .logo-header { text-align: center; margin-bottom: 25px; padding: 10px; }
        .logo-placeholder { font-size: 50px; background: #2d4d36; color: white; width: 90px; height: 90px; line-height: 90px; border-radius: 22px; margin: 0 auto; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #2d4d36; }
        h2 { margin: 0 0 5px 0; color: #2d4d36; font-size: 1.1em; text-transform: uppercase; }
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.85em; color: #444; }
        input, textarea, select { width: 100%; padding: 14px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; min-height: 50px; }
        input.invalid { border: 2px solid #c0392b; background-color: #fceae9; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .totaal-box { background: #f0f4f1; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; font-weight: bold; color: #2d4d36; border: 1px solid #d1dbd3; }
        .btn-send { background: #2d4d36; color: white; border: none; padding: 18px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-map { background: #2d4d36; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 15px; margin-top: 15px; cursor: pointer; width: 100%; font-weight: bold; }
        #map-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; }
        #map { width:100%; height:100%; }
        .map-controls { position:absolute; bottom:30px; left:10px; right:10px; display:flex; flex-direction:column; gap:10px; z-index:1001; }
        .map-btn { flex:1; background:#2d4d36; color:white; padding:18px; border-radius:12px; text-align:center; font-weight:bold; cursor:pointer; border:none; font-size:16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .measure-info { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:white; padding:10px 25px; border-radius:30px; font-weight:bold; z-index:1001; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid #2d4d36; }
    </style>
</head>
<body>

<div id="login-box" class="login-container">
    <div class="logo-header"><span class="logo-placeholder">üöú</span></div>
    <input type="password" id="pincode" placeholder="Pincode" style="text-align:center;">
    <button class="btn-send" onclick="checkCode()">INLOGGEN</button>
</div>

<div id="app-content" class="container">
    <div class="logo-header"><span class="logo-placeholder">üöú</span></div>
    
    <div class="card">
        <h2>Dagoverzicht</h2>
        <input type="text" id="medewerker" placeholder="Naam medewerker...">
        <div class="grid-3">
            <div><label>Start</label><input type="text" id="dag_start" placeholder="0:00" onblur="valideerVeld(this); calc()" oninput="formatTijd(this)"></div>
            <div><label>Eind</label><input type="text" id="dag_eind" placeholder="0:00" onblur="valideerVeld(this); calc()" oninput="formatTijd(this)"></div>
            <div><label>Pauze (m)</label><input type="number" id="dag_pauze" placeholder="" oninput="calc()"></div>
        </div>
        <div class="totaal-box">Totaal Dagtijd: <span id="totaalDagUren">0:00</span></div>
    </div>

    <div id="klanten-container"></div>

    <div class="card">
        <button class="btn-send" onclick="verstuurMail()">üìß WERKBON VERZENDEN</button>
    </div>
</div>

<div id="map-overlay">
    <div class="measure-info" id="distLabel">Afstand: 0.0 m</div>
    <div id="map"></div>
    <div class="map-controls">
        <button class="map-btn" onclick="clearMeasure()" style="background:#c0392b;">üßπ METING WISSEN</button>
        <button class="map-btn" onclick="closeMap()">‚úÖ OPSLAAN & SLUITEN</button>
    </div>
</div>

<script>
    let currentKlantIndex = 0;
    let map, marker, polyline, tempCircles = [];
    let measurePoints = [];
    let currentDistance = 0;

    function checkCode() {
        if (document.getElementById('pincode').value === "1234") {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            initMap();
        } else { alert("Onjuiste pincode"); }
    }

    // Slimme tijd-formatter
    function formatTijd(input) {
        let v = input.value.replace(/\D/g, ''); 
        if (v.length >= 3) {
            let uren = v.slice(0, -2);
            let minuten = v.slice(-2);
            input.value = uren + ":" + minuten;
        }
    }

    // Controleert op 59 minuten grens en voegt 0 toe indien nodig bij verlaten veld
    function valideerVeld(input) {
        let v = input.value;
        if (!v.includes(':') && v.length > 0) {
            if (v.length === 1) v = "0" + v + ":00";
            if (v.length === 2) v = v + ":00";
        }
        
        let parts = v.split(':');
        if (parts.length === 2) {
            let h = parts[0].padStart(2, '0');
            let m = parts[1].padEnd(2, '0');
            if (parseInt(m) > 59) {
                alert("Minuten kunnen niet hoger zijn dan 59. Gecorrigeerd naar 59.");
                m = "59";
            }
            input.value = h + ":" + m;
        }
    }

    const container = document.getElementById('klanten-container');
    for (let i = 1; i <= 5; i++) {
        container.innerHTML += `
            <div class="card">
                <h2>KLANT ${i}</h2>
                <label>Klantnaam</label><input type="text" id="klant_naam_${i}">
                <label>Machine / Kenteken</label><input type="text" id="klant_mach_${i}" placeholder="Kraan, trekker, etc.">
                <label>Werkzaamheden</label><textarea id="klant_werk_${i}" rows="2"></textarea>
                
                <div class="grid-3">
                    <div><label>Start</label><input type="text" id="k_start_${i}" placeholder="0:00" onblur="valideerVeld(this); calcK(${i})" oninput="formatTijd(this)"></div>
                    <div><label>Eind</label><input type="text" id="k_eind_${i}" placeholder="0:00" onblur="valideerVeld(this); calcK(${i})" oninput="formatTijd(this)"></div>
                    <div><label>Pauze (m)</label><input type="number" id="k_pauze_${i}" placeholder="" oninput="calcK(${i})"></div>
                </div>
                
                <div class="grid-2">
                    <div><label>Wachttijd (m)</label><input type="number" id="w_tijd_${i}" placeholder=""></div>
                    <div><label>Reden</label><select id="w_type_${i}"><option>Wachten</option><option>Defect</option><option>Anders</option></select></div>
                </div>
                
                <div class="grid-2">
                    <div><label>Laden</label><div style="display:flex;"><input type="text" id="l_h_${i}"><select id="l_e_${i}"><option>m3</option><option>Ton</option><option>kg</option></select></div></div>
                    <div><label>Lossen</label><div style="display:flex;"><input type="text" id="lo_h_${i}"><select id="lo_e_${i}"><option>m3</option><option>Ton</option><option>kg</option></select></div></div>
                </div>

                <input type="hidden" id="klant_locatie_${i}">
                <input type="hidden" id="klant_meting_${i}" value="0">
                <button class="btn-map" onclick="openMap(${i})">üõ∞Ô∏è KAART & AFSTAND METEN</button>
                
                <div class="totaal-box">Uren Klant ${i}: <span id="totaal_k_${i}">0:00</span></div>
            </div>
        `;
    }

    function initMap() {
        map = L.map('map', {zoomControl: false}).setView([51.712, 5.869], 13);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
        marker = L.marker([51.712, 5.869], {draggable: true}).addTo(map);
        polyline = L.polyline([], {color: '#f39c12', weight: 4}).addTo(map);
        map.on('click', function(e) {
            measurePoints.push(e.latlng);
            polyline.setLatLngs(measurePoints);
            let c = L.circleMarker(e.latlng, {radius: 6, color: '#f39c12', fillColor:'#fff', fillOpacity: 1}).addTo(map);
            tempCircles.push(c);
            updateDist();
        });
    }

    function clearMeasure() {
        measurePoints = []; polyline.setLatLngs([]);
        tempCircles.forEach(c => map.removeLayer(c));
        tempCircles = []; currentDistance = 0;
        document.getElementById('distLabel').innerHTML = "Afstand: 0.0 m";
    }

    function updateDist() {
        let d = 0;
        for (let i = 0; i < measurePoints.length - 1; i++) { d += measurePoints[i].distanceTo(measurePoints[i+1]); }
        currentDistance = d.toFixed(1);
        document.getElementById('distLabel').innerHTML = "Afstand: " + currentDistance + " m";
    }

    function openMap(i) {
        currentKlantIndex = i;
        document.getElementById('map-overlay').style.display = 'block';
        setTimeout(() => { 
            map.invalidateSize();
            navigator.geolocation.getCurrentPosition((pos) => {
                let ll = [pos.coords.latitude, pos.coords.longitude];
                map.setView(ll, 19); marker.setLatLng(ll);
            }, null, {enableHighAccuracy: true});
        }, 300);
    }

    function closeMap() {
        const pos = marker.getLatLng();
        document.getElementById("klant_locatie_" + currentKlantIndex).value = pos.lat.toFixed(6) + "," + pos.lng.toFixed(6);
        document.getElementById("klant_meting_" + currentKlantIndex).value = currentDistance;
        document.getElementById('map-overlay').style.display = 'none';
        clearMeasure();
    }

    function parseTijd(t) {
        if (!t || !t.includes(':')) return null;
        let p = t.split(':');
        return (parseInt(p[0]) * 60) + parseInt(p[1]);
    }

    function bereken(sId, eId, pId) {
        let s = parseTijd(document.getElementById(sId).value);
        let e = parseTijd(document.getElementById(eId).value);
        let p = parseInt(document.getElementById(pId).value) || 0;
        if (s === null || e === null) return "0:00";
        let t = e - s - p;
        if (t < 0) return "0:00";
        return Math.floor(t/60) + ":" + (t%60 < 10 ? '0' : '') + (t%60);
    }
    
    function calc() { document.getElementById('totaalDagUren').innerText = bereken('dag_start', 'dag_eind', 'dag_pauze'); }
    function calcK(i) { document.getElementById("totaal_k_" + i).innerText = bereken("k_start_" + i, "k_eind_" + i, "k_pauze_" + i); }

    function verstuurMail() {
        if (!confirm("Controleer je werkbon op onjuistheden voor je deze verzendt! Is alles correct ingevuld?")) return;

        const med = document.getElementById('medewerker').value || "Onbekend";
        const datum = new Date().toLocaleDateString('nl-NL');
        let body = "WERKBON\nMedewerker: " + med + "\nDatum: " + datum + "\n";
        body += "Totaal gewerkt: " + document.getElementById('totaalDagUren').innerText + "\n---------------------------\n\n";
        
        for(let i=1; i<=5; i++) {
            let n = document.getElementById("klant_naam_" + i).value;
            if(n) {
                body += "KLANT: " + n + "\n";
                let m = document.getElementById("klant_mach_" + i).value;
                if(m) body += "MACHINE: " + m + "\n";
                body += "WERK: " + document.getElementById("klant_werk_" + i).value + "\n";
                let lh = document.getElementById("l_h_" + i).value;
                if(lh) body += "LADEN: " + lh + " " + document.getElementById("l_e_" + i).value + "\n";
                let loh = document.getElementById("lo_h_" + i).value;
                if(loh) body += "LOSSEN: " + loh + " " + document.getElementById("lo_e_" + i).value + "\n";
                body += "UREN: " + document.getElementById("totaal_k_" + i).innerText;
                let w = document.getElementById("w_tijd_" + i).value;
                if(w > 0) body += " (waarvan " + w + " min wachttijd wegens: " + document.getElementById("w_type_" + i).value + ")";
                body += "\n";
                let mtr = document.getElementById("klant_meting_" + i).value;
                if(mtr > 0) body += "üìè AFSTAND: " + mtr + " meter\n";
                let loc = document.getElementById("klant_locatie_" + i).value;
                if(loc) body += "üìç LOCATIE: https://www.google.com/maps?q=" + loc + "\n";
                body += "\n";
            }
        }
        window.location.href = "mailto:?subject=Werkbon " + med + "&body=" + encodeURIComponent(body);
    }
</script>
</body>
</html>
